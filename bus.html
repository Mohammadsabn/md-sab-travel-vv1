<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Booking - TravelEase</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Define Custom Colors for Tailwind (Primary: Emerald/Green) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Custom primary color (matching emerald-600)
                        'primary': '#059669', 
                        'primary-hover': '#047857',
                    },
                }
            }
        }
    </script>

    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ87od/hH2uoFrJdK/W4pE5yJ8T4nK/W4yT/h6/H/9/Q8C0S6P+I/J+I/K+S+A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .search-card {
            margin-top: 4rem;
        }

        /* Basic CSS for smooth view transitions */
        .view {
            opacity: 0;
            transition: opacity 0.5s ease;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        .view.active {
            opacity: 1;
            position: relative;
            display: block;
        }
        
        /* Utility for the ticket download button animation */
        .download-button:hover .fa-download {
            transform: translateY(-2px);
            transition: transform 0.2s ease-in-out;
        }

        /* Custom Seat Styles */
        .seat {
            width: 40px;
            height: 40px;
            margin: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px 8px 3px 3px; /* Slightly rounded top, flat bottom */
            font-size: 10px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.15s ease;
            font-weight: 600;
        }

        .seat.available {
            background-color: #ecfdf5; /* Emerald 50 */
            color: #065f46; /* Emerald 800 */
            border: 1px solid #34d399; /* Emerald 400 */
        }
        .seat.available:hover {
            transform: scale(1.05);
            background-color: #a7f3d0; /* Emerald 200 */
        }

        .seat.booked {
            background-color: #fca5a5; /* Red 300 */
            color: #7f1d1d; /* Red 900 */
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        .seat.selected {
            background-color: #059669; /* Primary */
            color: white;
            border: 1px solid #047857; /* Primary Dark */
            transform: scale(1.08);
            box-shadow: 0 3px 6px rgba(5, 150, 105, 0.4);
        }

        .seat-row {
            display: flex;
            margin-bottom: 10px;
        }

        .seat-map-aisle {
            width: 30px; /* Space for the aisle */
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-10 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-bus-alt text-primary text-3xl"></i>
                    <h1 class="text-3xl font-extrabold text-gray-800">Journey<span class="text-primary">Ease</span></h1>
                </div>
                <nav class="hidden md:flex space-x-6 items-end">
                    <!-- Flights Tab -->
                    <a href="index.html" class="tab px-2 py-1 text-gray-600 hover:text-primary flex items-center transition duration-150"><i class="fas fa-plane mr-2"></i>Flights</a>
                    <!-- Trains Tab -->
                    <a href="train.html" class="tab px-2 py-1 text-gray-600 hover:text-primary flex items-center transition duration-150"><i class="fas fa-train mr-2"></i>Trains</a>
                    
                    <!-- Active Tab -->
                    <a href="bus.html" class="tab px-2 py-1 text-primary font-bold flex items-center border-b-2 border-primary transition duration-150"><i class="fas fa-bus-alt mr-2"></i>Buses</a>
                    
                    <!-- Other Tabs -->
                    <a href="hotel.html" class="tab px-2 py-1 text-gray-600 hover:text-primary flex items-center transition duration-150"><i class="fas fa-hotel mr-2"></i>Hotels</a>
                    <a href="cabs.html" class="tab px-2 py-1 text-gray-600 hover:text-primary flex items-center transition duration-150"><i class="fas fa-taxi mr-2"></i>Cabs</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content Wrapper: This holds all the switchable views -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-12 relative">
        
        <!-- ==================================================================== -->
        <!-- 1. SEARCH VIEW (Initial Screen) -->
        <!-- ==================================================================== -->
        <div id="search-view" class="view active">
            <div class="bg-white p-6 md:p-8 rounded-xl search-card shadow-2xl shadow-emerald-100/50 relative z-0">
                <h2 class="text-2xl md:text-3xl font-extrabold text-gray-800 mb-6">Search for Buses</h2>
                
                <form id="bus-search-form" onsubmit="handleBusSearch(event)" class="space-y-6">
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        
                        <!-- From -->
                        <div>
                            <label for="from" class="block text-sm font-medium text-gray-700 mb-1"><i class="fas fa-map-marker-alt text-red-500 mr-1"></i> From</label>
                            <input type="text" id="from" name="from" value="Bengaluru" placeholder="Origin City" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" required>
                        </div>

                        <!-- To -->
                        <div>
                            <label for="to" class="block text-sm font-medium text-gray-700 mb-1"><i class="fas fa-map-marker-alt text-green-500 mr-1"></i> To</label>
                            <input type="text" id="to" name="to" value="Chennai" placeholder="Destination City" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" required>
                        </div>

                        <!-- Departure Date -->
                        <div>
                            <label for="departure_date" class="block text-sm font-medium text-gray-700 mb-1"><i class="fas fa-calendar-alt text-primary mr-1"></i> Departure</label>
                            <input type="date" id="departure_date" name="departure_date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" required>
                        </div>

                    </div>

                    <!-- Passengers -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="passengers" class="block text-sm font-medium text-gray-700 mb-1"><i class="fas fa-users text-teal-500 mr-1"></i> Passengers</label>
                            <select id="passengers" name="passengers" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                                <option value="1">1 Adult</option>
                                <option value="2" selected>2 Adults</option> 
                                <option value="3">3 Adults</option>
                                <option value="4">4 Adults</option>
                            </select>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <div class="text-center pt-4">
                        <button type="submit" class="w-full sm:w-1/2 lg:w-1/3 py-4 px-6 bg-primary text-white font-bold text-lg rounded-full hover:bg-primary-hover transition duration-300 shadow-xl shadow-emerald-400/50 flex items-center justify-center mx-auto transform hover:scale-[1.01]">
                            <i class="fas fa-search mr-2"></i> Search Buses
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ==================================================================== -->
        <!-- 2. RESULTS VIEW (Select Bus) -->
        <!-- ==================================================================== -->
        <div id="results-view" class="view">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Available Buses <span id="route-display" class="text-primary text-xl font-semibold ml-2"></span></h2>
            <div class="bg-white p-6 rounded-xl shadow-2xl shadow-emerald-100/50 space-y-4">
                
                <!-- Back Button -->
                <button onclick="switchView('search-view')" class="text-sm font-medium text-primary hover:text-primary-hover transition mb-4 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Search
                </button>

                <!-- Sample Bus Result 1 -->
                <div class="border border-gray-200 rounded-xl p-4 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-lg transition duration-200">
                    <div class="flex-grow">
                        <p class="text-xl font-bold text-gray-800">Red Line Volvo (AC Sleeper)</p>
                        <p class="text-sm text-gray-500">Departure: 21:00 | Arrival: 06:30 (+1 day) | Duration: 9h 30m</p>
                        <p class="text-lg font-semibold text-teal-600 mt-1">Price per person: <span class="text-gray-800 font-bold">₹ 1,850</span> | Seats Available: 8</p>
                    </div>
                    <div class="text-right mt-3 md:mt-0">
                        <button onclick="handleSelectBus('Red Line Volvo', '1850')" class="mt-2 py-2 px-6 bg-primary text-white font-medium rounded-lg hover:bg-primary-hover transition duration-200 shadow-md flex items-center justify-center">
                            <i class="fas fa-check-circle mr-2"></i> Select Seats
                        </button>
                    </div>
                </div>

                <!-- Sample Bus Result 2 -->
                <div class="border border-gray-200 rounded-xl p-4 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-lg transition duration-200">
                    <div class="flex-grow">
                        <p class="text-xl font-bold text-gray-800">KSRTC Executive (Non-AC Seater)</p>
                        <p class="text-sm text-gray-500">Departure: 13:00 | Arrival: 23:59 | Duration: 10h 59m</p>
                        <p class="text-lg font-semibold text-teal-600 mt-1">Price per person: <span class="text-gray-800 font-bold">₹ 980</span> | Seats Available: 22</p>
                    </div>
                    <div class="text-right mt-3 md:mt-0">
                        <button onclick="handleSelectBus('KSRTC Executive', '980')" class="mt-2 py-2 px-6 bg-primary text-white font-medium rounded-lg hover:bg-primary-hover transition duration-200 shadow-md flex items-center justify-center">
                             <i class="fas fa-check-circle mr-2"></i> Select Seats
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================================================================== -->
        <!-- 2.5. SEAT VIEW (Select Seats) -->
        <!-- ==================================================================== -->
        <div id="seat-view" class="view">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Select Your Seats</h2>
            <div class="bg-white p-6 rounded-xl shadow-2xl shadow-emerald-100/50">
                <button onclick="switchView('results-view')" class="text-sm font-medium text-primary hover:text-primary-hover transition mb-4 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Change Bus
                </button>

                <div class="flex justify-center p-4 rounded-lg flex-wrap gap-4">
                    <!-- Legend -->
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <div class="w-3 h-3 rounded-full bg-emerald-500"></div><span>Available</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <div class="w-3 h-3 rounded-full bg-red-400"></div><span>Booked</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <div class="w-3 h-3 rounded-full bg-primary"></div><span>Selected</span>
                    </div>
                </div>
                
                <div id="seat-map-container" class="flex justify-center p-4 bg-gray-50 rounded-lg shadow-inner">
                    <!-- Seat Map will be generated here by JavaScript -->
                </div>

                <div class="mt-8 pt-4 border-t border-gray-200">
                    <div id="seat-info-summary" class="text-center text-lg font-semibold mb-4 text-gray-700">
                        <!-- Summary info here -->
                    </div>
                    <div class="text-center">
                        <button onclick="handleProceedToPassengers()" id="proceed-to-passenger-btn" disabled class="w-full md:w-1/3 py-3 px-6 bg-gray-400 text-white font-bold text-lg rounded-full transition duration-300 shadow-xl disabled:opacity-50">
                            Select Remaining Seats
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================================================================== -->
        <!-- 3. PASSENGER VIEW (Enter Passenger Details) -->
        <!-- ==================================================================== -->
        <div id="passenger-view" class="view">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Passenger Details</h2>
            <p class="text-lg text-gray-600 mb-6">
                Booking: <span id="bus-name-display" class="font-bold text-primary"></span> 
                (<span class="font-bold text-primary">₹ <span id="bus-price-per-person"></span> per person</span>)
            </p>

            <div class="bg-white p-6 rounded-xl shadow-2xl shadow-emerald-100/50">
                <button onclick="switchView('seat-view')" class="text-sm font-medium text-primary hover:text-primary-hover transition mb-4 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Change Seats
                </button>
                
                <form id="passenger-form" onsubmit="handlePassengerForm(event)" class="space-y-6">
                    
                    <!-- Dynamic Passenger Forms Container -->
                    <div id="passenger-forms-container" class="space-y-4">
                        <!-- Forms will be injected here by JavaScript -->
                    </div>

                    <!-- Contact Details -->
                    <h3 class="font-bold text-xl text-gray-800 pt-4 border-t mt-6">Contact Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="email" value="jane@example.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="phone" value="+919876543210" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                        </div>
                    </div>

                    <!-- Proceed Button -->
                    <div class="text-center pt-6">
                        <button type="submit" class="w-full md:w-1/3 py-3 px-6 bg-primary text-white font-bold text-lg rounded-full hover:bg-primary-hover transition duration-300 shadow-xl">
                            <i class="fas fa-credit-card mr-2"></i> Proceed to Pay
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ==================================================================== -->
        <!-- 4. PAYMENT VIEW (Simplified Payment Gateway) -->
        <!-- ==================================================================== -->
        <div id="payment-view" class="view">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Complete Payment</h2>
            
            <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl shadow-emerald-100/50 max-w-lg mx-auto">
                <p class="text-2xl font-bold text-red-600 mb-4">Total Amount: <span id="final-price-display" class="text-3xl"></span></p>
                <p class="text-sm text-gray-600 mb-6">Includes base fare, taxes, and service fees for <span id="num-passengers-display" class="font-semibold text-primary"></span> travelers.</p>
                
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6" role="alert">
                    <p class="font-medium text-yellow-700">Payment Gateway Simulation</p>
                    <p class="text-sm text-yellow-700">No real transaction will occur. Click 'Pay Now' to confirm booking.</p>
                </div>

                <div class="space-y-4">
                    <!-- Placeholder Card Details -->
                    <div>
                        <label for="card-number" class="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                        <input type="text" id="card-number" value="4111 2222 3333 4444" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="expiry" class="block text-sm font-medium text-gray-700 mb-1">Expiry</label>
                            <input type="text" id="expiry" value="09/27" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                        <div class="col-span-2">
                            <label for="cvv" class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
                            <input type="text" id="cvv" value="456" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                </div>

                <!-- Pay Button -->
                <div class="text-center pt-8">
                    <button onclick="handlePayment()" class="w-full py-3 px-6 bg-primary text-white font-bold text-lg rounded-full hover:bg-primary-hover transition duration-300 shadow-xl">
                        <i class="fas fa-lock mr-2"></i> Pay Now
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ==================================================================== -->
        <!-- 5. CONFIRMATION VIEW (Success and Download) -->
        <!-- ==================================================================== -->
        <div id="confirmation-view" class="view">
            <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl shadow-green-200/50 text-center max-w-xl mx-auto">
                <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                <h2 class="text-4xl font-extrabold text-gray-800 mb-2">Bus Ticket Confirmed!</h2>
                <p class="text-xl text-gray-600 mb-6">Your e-ticket has been successfully processed.</p>
                
                <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-8 text-left">
                    <p class="text-md text-green-800 font-semibold mb-1">Booking ID: <span class="font-bold">BUS-951048</span></p>
                    <p class="text-sm text-green-700">Bus Operator: <span id="final-bus-name" class="font-medium"></span></p>
                    <p class="text-sm text-green-700">Route: <span id="final-route-display" class="font-medium"></span></p>
                    <p class="text-sm text-green-700">Selected Seats: <span id="final-seats-display" class="font-bold"></span></p>
                    <p class="text-lg text-green-800 font-bold mt-2 border-t pt-2">Total Paid: <span id="final-price-confirmation"></span></p>
                </div>

                <!-- Download Button -->
                <button onclick="downloadTicketPdf()" class="download-button w-full py-3 px-6 bg-primary text-white font-bold text-lg rounded-full hover:bg-primary-hover transition duration-300 shadow-xl flex items-center justify-center">
                    <i class="fas fa-download mr-3 transition duration-200"></i> Download E-Ticket (PDF)
                </button>

                <!-- Start New Search -->
                <button onclick="switchView('search-view')" class="mt-4 text-primary hover:text-primary-hover transition font-medium">
                    <i class="fas fa-plus mr-1"></i> Start a New Search
                </button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-sm text-gray-500">
            &copy; <span id="current-year-footer"></span> JourneyEase Demo. All rights reserved.
        </div>
    </footer>

    <!-- Simple Message Box (Required by JS functions) -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl text-center max-w-xs">
            <p id="message-content" class="text-gray-800 font-semibold mb-4"></p>
            <button onclick="hideMessageBox()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition">OK</button>
        </div>
    </div>

    <script>
        // Global state to store booking details across views
        let bookingDetails = {
            from: '',
            to: '',
            date: '',
            passengers: 0,
            busName: '',
            price: 0, // Price per person
            totalPrice: 0,
            selectedSeats: [], // Array to store selected seat IDs (e.g., ['A1', 'B2'])
            passengersData: []
        };

        // Simulated Seat Data (2x2 layout for a 40-seater bus - 10 rows, 4 seats each)
        // A & B are left side, C & D are right side, with an aisle between B and C
        const SEAT_MAP_DATA = [
            { id: 'A1', status: 'booked' }, { id: 'B1', status: 'available' }, { id: 'C1', status: 'available' }, { id: 'D1', status: 'available' },
            { id: 'A2', status: 'available' }, { id: 'B2', status: 'available' }, { id: 'C2', status: 'available' }, { id: 'D2', status: 'booked' },
            { id: 'A3', status: 'booked' }, { id: 'B3', status: 'available' }, { id: 'C3', status: 'available' }, { id: 'D3', status: 'available' },
            { id: 'A4', status: 'available' }, { id: 'B4', status: 'booked' }, { id: 'C4', status: 'available' }, { id: 'D4', status: 'available' },
            { id: 'A5', status: 'available' }, { id: 'B5', status: 'available' }, { id: 'C5', status: 'booked' }, { id: 'D5', status: 'available' },
            { id: 'A6', status: 'available' }, { id: 'B6', status: 'available' }, { id: 'C6', status: 'available' }, { id: 'D6', status: 'available' },
            { id: 'A7', status: 'booked' }, { id: 'B7', status: 'available' }, { id: 'C7', status: 'available' }, { id: 'D7', status: 'available' },
            { id: 'A8', status: 'available' }, { id: 'B8', status: 'booked' }, { id: 'C8', status: 'available' }, { id: 'D8', status: 'booked' },
            { id: 'A9', status: 'available' }, { id: 'B9', status: 'available' }, { id: 'C9', status: 'available' }, { id: 'D9', status: 'available' },
            { id: 'A10', status: 'available' }, { id: 'B10', status: 'available' }, { id: 'C10', status: 'available' }, { id: 'D10', status: 'available' },
        ];


        // Initialize the year in the footer
        document.getElementById('current-year-footer').textContent = new Date().getFullYear();

        // --- CORE VIEW SWITCHING LOGIC ---

        /**
         * Switches the active content view by setting the 'active' class.
         * @param {string} viewId - The ID of the view div to show (e.g., 'results-view').
         */
        function switchView(viewId) {
            const views = document.querySelectorAll('.view');
            views.forEach(view => {
                view.classList.remove('active');
            });
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
                window.scrollTo(0, 0); // Scroll to top for new view
            }
        }

        // --- STEP 1: SEARCH VIEW HANDLER ---
        function handleBusSearch(event) {
            event.preventDefault(); 
            
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            const date = document.getElementById('departure_date').value;
            const passengers = document.getElementById('passengers').value;

            if (!from || !to || !date) {
                showMessageBox("Please fill out all required fields.");
                return;
            }

            // Store search data globally
            bookingDetails.from = from;
            bookingDetails.to = to;
            bookingDetails.date = date;
            bookingDetails.passengers = parseInt(passengers); // Store as integer

            // Update route display on the results page
            document.getElementById('route-display').textContent = 
                `${from} to ${to} on ${date}`;

            // Go to Step 2: Results View
            switchView('search-view'); // Show search first, then results
            setTimeout(() => switchView('results-view'), 100); // Small delay to ensure smooth transition
        }

        // --- STEP 2: RESULTS VIEW HANDLER (Select Bus) ---
        function handleSelectBus(busName, price) {
            // Store selected bus details globally
            bookingDetails.busName = busName;
            bookingDetails.price = parseFloat(price); // Price per person
            bookingDetails.selectedSeats = []; // Reset seats for new bus

            // Update details on the seat selection page (uses elements defined in passenger view, but shared for display)
            document.getElementById('bus-name-display').textContent = busName;
            document.getElementById('bus-price-per-person').textContent = price;

            // Render the seat map for the selected bus
            renderSeatMap();
            
            // Go to Step 2.5: Seat View
            switchView('seat-view');
        }

        // --- STEP 2.5: SEAT SELECTION LOGIC ---

        function updateSeatSummary() {
            const summaryEl = document.getElementById('seat-info-summary');
            const required = bookingDetails.passengers;
            const selected = bookingDetails.selectedSeats.length;
            const proceedBtn = document.getElementById('proceed-to-passenger-btn');
            
            summaryEl.innerHTML = `
                You need to select <span class="text-primary font-extrabold">${required}</span> seat${required > 1 ? 's' : ''}.
                Currently selected: <span class="font-extrabold ${selected === required ? 'text-green-600' : 'text-orange-500'}">${selected}</span>.
                ${selected > 0 ? `<br>Selected Seats: <span class="text-gray-900 font-normal text-sm">${bookingDetails.selectedSeats.join(', ')}</span>` : ''}
            `;

            if (selected === required) {
                proceedBtn.classList.remove('bg-gray-400');
                proceedBtn.classList.add('bg-primary', 'hover:bg-primary-hover');
                proceedBtn.removeAttribute('disabled');
                proceedBtn.textContent = `Proceed with ${selected} Seat${selected > 1 ? 's' : ''}`;
            } else {
                proceedBtn.classList.add('bg-gray-400');
                proceedBtn.classList.remove('bg-primary', 'hover:bg-primary-hover');
                proceedBtn.setAttribute('disabled', 'true');
                proceedBtn.textContent = 'Select Remaining Seats';
            }
        }

        function handleSeatSelection(seatId, seatStatus, element) {
            if (seatStatus === 'booked') {
                showMessageBox(`Seat ${seatId} is already booked.`);
                return;
            }

            const index = bookingDetails.selectedSeats.indexOf(seatId);
            const requiredSeats = bookingDetails.passengers;

            if (index > -1) {
                // Deselect seat
                bookingDetails.selectedSeats.splice(index, 1);
                element.classList.remove('selected');
                element.classList.add('available');
            } else {
                // Select seat
                if (bookingDetails.selectedSeats.length < requiredSeats) {
                    bookingDetails.selectedSeats.push(seatId);
                    element.classList.add('selected');
                    element.classList.remove('available');
                } else {
                    showMessageBox(`You can only select ${requiredSeats} seat${requiredSeats > 1 ? 's' : ''}.`);
                }
            }
            updateSeatSummary();
        }

        function renderSeatMap() {
            const container = document.getElementById('seat-map-container');
            container.innerHTML = '';
            
            const mapGrid = document.createElement('div');
            mapGrid.className = 'flex flex-col border border-gray-300 p-4 rounded-xl shadow-inner bg-gray-100 max-w-fit mx-auto';
            container.appendChild(mapGrid);

            // Create a row for the driver cabin/front
            const frontRowEl = document.createElement('div');
            frontRowEl.className = 'seat-row justify-end mb-4';
            frontRowEl.innerHTML = `
                <div class="seat bg-gray-300 text-gray-700 cursor-default" style="width: 80px;">Driver</div>
            `;
            mapGrid.appendChild(frontRowEl);

            // Group seats by row number (1-10)
            const seatsByRow = SEAT_MAP_DATA.reduce((acc, seat) => {
                const rowNum = parseInt(seat.id.match(/\d+/)[0]);
                if (!acc[rowNum]) acc[rowNum] = [];
                acc[rowNum].push(seat);
                return acc;
            }, {});

            // Render 10 rows
            for (let row = 1; row <= 10; row++) {
                const rowData = seatsByRow[row] || [];
                const rowEl = document.createElement('div');
                rowEl.className = 'seat-row';

                rowData.forEach((seat, index) => {
                    const seatEl = document.createElement('div');
                    
                    // Check if seat was previously selected (important if user navigates back)
                    const isSelected = bookingDetails.selectedSeats.includes(seat.id);
                    const statusClass = isSelected ? 'selected' : seat.status;

                    seatEl.className = `seat ${statusClass}`;
                    seatEl.textContent = seat.id;
                    seatEl.id = `seat-${seat.id}`;
                    
                    if (seat.status !== 'booked') {
                        seatEl.onclick = () => handleSeatSelection(seat.id, seat.status, seatEl);
                    }

                    // Insert aisle space after the second seat (column 'B')
                    rowEl.appendChild(seatEl);
                    if (index === 1) {
                        const aisle = document.createElement('div');
                        aisle.className = 'seat-map-aisle';
                        rowEl.appendChild(aisle);
                    }
                });
                mapGrid.appendChild(rowEl);
            }
            
            // Update the summary initially
            updateSeatSummary();
        }

        // --- STEP 2.5: SEAT VIEW HANDLER (Proceed to Passengers) ---
        function handleProceedToPassengers() {
            // Check again to be safe, though button should be disabled if not ready
            if (bookingDetails.selectedSeats.length !== bookingDetails.passengers) {
                showMessageBox("Please select exactly the number of seats required to proceed.");
                return;
            }

            // Sort seats for clean display (e.g., A1, B1, C2...)
            bookingDetails.selectedSeats.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

            // Render the required number of passenger forms, now including seat numbers
            renderPassengerForms();

            // Go to Step 3: Passenger View
            switchView('passenger-view');
        }


        // --- Dynamic Form Rendering ---
        function renderPassengerForms() {
            const container = document.getElementById('passenger-forms-container');
            container.innerHTML = ''; // Clear existing forms
            const numPassengers = bookingDetails.passengers || 1; // Default to 1 if missing
            const seats = bookingDetails.selectedSeats; // Get selected seats

            for (let i = 1; i <= numPassengers; i++) {
                // Assign seat from the sorted array
                const assignedSeat = seats[i - 1] ? seats[i - 1] : 'N/A';

                // Pre-fill primary passenger (i=1) with example data
                const defaultName = i === 1 ? 'Jane Doe' : `Traveler ${i}`;
                const defaultAge = i === 1 ? 30 : (25 + i);

                const passengerHtml = `
                    <div class="border p-4 rounded-xl bg-emerald-50 shadow-md">
                        <h3 class="font-bold text-xl text-emerald-700 mb-2">
                            Passenger ${i} ${i === 1 ? '(Primary Traveler)' : `(Adult ${i})`}
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">
                            Assigned Seat: <span class="font-extrabold text-primary text-lg">${assignedSeat}</span>
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="p${i}-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="p${i}-name" name="p${i}-name" value="${defaultName}" class="passenger-input w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            </div>
                            <div>
                                <label for="p${i}-age" class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                                <input type="number" id="p${i}-age" name="p${i}-age" value="${defaultAge}" min="1" max="100" class="passenger-input w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            </div>
                            <div>
                                <label for="p${i}-gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                                <select id="p${i}-gender" name="p${i}-gender" class="passenger-input w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white" required>
                                    <option value="Female" ${i === 1 ? 'selected' : ''}>Female</option>
                                    <option value="Male">Male</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', passengerHtml);
            }
        }

        // --- STEP 3: PASSENGER VIEW HANDLER ---
        function handlePassengerForm(event) {
            event.preventDefault();

            // Simple validation check for all dynamically generated passenger fields
            const requiredInputs = document.querySelectorAll('.passenger-input');
            let allFilled = true;
            requiredInputs.forEach(input => {
                if (!input.value) {
                    allFilled = false;
                }
            });

            if (!allFilled || !document.getElementById('email').value || !document.getElementById('phone').value) {
                showMessageBox("Please ensure ALL passenger and contact details are filled correctly.");
                return;
            }

            // Calculate total price and update state
            bookingDetails.totalPrice = bookingDetails.price * bookingDetails.passengers;

            // Update price displays
            document.getElementById('final-price-display').textContent = `₹ ${bookingDetails.totalPrice.toFixed(2)}`;
            document.getElementById('num-passengers-display').textContent = `${bookingDetails.passengers} adult${bookingDetails.passengers > 1 ? 's' : ''}`;

            // Go to Step 4: Payment View
            switchView('payment-view');
        }

        // --- STEP 4: PAYMENT VIEW HANDLER ---
        function handlePayment() {
            showMessageBox("Processing your payment. Please wait...");
            
            // Wait a moment before switching to confirmation
            setTimeout(() => {
                hideMessageBox();
                
                // Update final confirmation details
                document.getElementById('final-bus-name').textContent = bookingDetails.busName;
                document.getElementById('final-route-display').textContent = `${bookingDetails.from} to ${bookingDetails.to}`;
                document.getElementById('final-seats-display').textContent = bookingDetails.selectedSeats.join(', ');
                document.getElementById('final-price-confirmation').textContent = `₹ ${bookingDetails.totalPrice.toFixed(2)}`;

                // Go to Step 5: Confirmation View
                switchView('confirmation-view');
            }, 1500); // 1.5 second delay for dramatic effect
        }

        // --- STEP 5: CONFIRMATION VIEW HANDLER (Download PDF) ---
        function downloadTicketPdf() {
            // Collect passenger data for the file content
            const passengersList = [];
            for (let i = 1; i <= bookingDetails.passengers; i++) {
                // Collect assigned seat number
                const assignedSeat = bookingDetails.selectedSeats[i - 1] || 'N/A';

                passengersList.push(
                    `Seat ${assignedSeat}: ${document.getElementById(`p${i}-name`).value} (Age: ${document.getElementById(`p${i}-age`).value}, Gender: ${document.getElementById(`p${i}-gender`).value})`
                );
            }

            const ticketInfo = `
=============================================
             E-TICKET CONFIRMATION
=============================================
Booking ID: BUS-951048
Bus Operator: ${bookingDetails.busName}
Route: ${bookingDetails.from} to ${bookingDetails.to}
Departure Date: ${bookingDetails.date}
Selected Seats: ${bookingDetails.selectedSeats.join(', ')}
Total Paid: ₹ ${bookingDetails.totalPrice.toFixed(2)}

---------------------------------------------
PASSENGER DETAILS (${bookingDetails.passengers} Travelers)
---------------------------------------------
${passengersList.join('\n')}

---------------------------------------------
CONTACT DETAILS
---------------------------------------------
Email: ${document.getElementById('email').value}
Phone: ${document.getElementById('phone').value}

=============================================
This is a simulated ticket for demonstration.
Thank you for booking with JourneyEase!
=============================================
`;
            // Simple text file download simulation for PDF
            const blob = new Blob([ticketInfo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Bus_Ticket_${bookingDetails.busName.replace(/\s/g, '_')}_Seats-${bookingDetails.selectedSeats.join('-')}.txt`; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessageBox("E-Ticket simulated download complete!");
        }


        // --- UTILITY: MESSAGE BOX ---
        
        /**
         * Shows a custom message box instead of using the forbidden alert().
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            document.getElementById('message-content').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }
    </script>
</body>
</html>
